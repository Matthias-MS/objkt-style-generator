<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MNTG Artist Style Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gifshot/0.4.5/gifshot.min.js"></script>
    <style>
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        @keyframes pulse-indigo { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .anim-loading { animation: pulse-indigo 1.5s infinite; }
        #promptLogBox { white-space: pre-wrap; word-break: break-word; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 font-sans min-h-screen flex items-center justify-center p-4">

    <div class="max-w-2xl w-full">
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-4xl font-black text-slate-800 tracking-tighter uppercase italic">Style Gen<span class="text-indigo-600">.AI</span></h1>
            <p class="text-slate-400 text-xs font-bold uppercase tracking-[0.3em]">Powered by MNTG Engine</p>
        </header>

        <!-- Main Card -->
        <div class="glass rounded-[2rem] shadow-2xl p-8 border border-white space-y-6">
            
            <!-- API Key Setup (Wird ausgeblendet wenn gespeichert) -->
            <div id="tokenSection" class="p-4 bg-indigo-50 rounded-2xl border border-indigo-100">
                <label class="block text-[10px] font-black text-indigo-400 uppercase mb-2">Hugging Face Token Setup (hf_...)</label>
                <div class="flex gap-2">
                    <input type="password" id="hfTokenInput" placeholder="Token hier einfügen..." class="flex-1 px-4 py-2 text-sm rounded-xl border-none outline-none focus:ring-2 focus:ring-indigo-500">
                    <button onclick="saveToken()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold uppercase hover:bg-indigo-700 transition">Save</button>
                </div>
            </div>

            <!-- Main Input -->
            <div id="mainInputGroup">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Artist Profile Link</label>
                <input type="text" id="artistUrl" placeholder="https://objkt.com/users/..." 
                    class="w-full px-5 py-4 rounded-2xl border-none bg-slate-50 focus:ring-4 focus:ring-indigo-100 outline-none transition-all text-lg shadow-inner">
            </div>

            <!-- Manual Input Fallback -->
            <div id="manualInputGroup" class="hidden p-4 bg-amber-50 rounded-2xl border border-amber-100">
                <label class="block text-xs font-bold text-amber-600 uppercase mb-2">Blockchain Timeout. Gib Stil manuell ein:</label>
                <input type="text" id="manualStyle" placeholder="z.B. Abstract, Dark Surrealism, Neon Colors..." 
                    class="w-full px-4 py-3 rounded-xl border-none bg-white outline-none focus:ring-2 focus:ring-amber-500">
            </div>

            <!-- Mode Selection -->
            <div class="grid grid-cols-2 gap-4">
                <button id="modeImage" onclick="setMode('image')" class="py-4 rounded-2xl border-2 border-indigo-600 bg-indigo-600 text-white font-black text-xs uppercase tracking-widest shadow-lg shadow-indigo-200 transition-all">Single Image</button>
                <button id="modeGif" onclick="setMode('gif')" class="py-4 rounded-2xl border-2 border-slate-100 bg-slate-50 text-slate-400 font-black text-xs uppercase tracking-widest hover:border-slate-200 transition-all">Animated GIF</button>
            </div>

            <!-- Action Button -->
            <button id="generateBtn" onclick="ignite()" class="w-full bg-slate-900 hover:bg-black text-white py-6 rounded-3xl font-black text-xl uppercase tracking-tighter transition-all active:scale-95 shadow-2xl">
                Generate Artwork
            </button>

            <!-- Progress Area -->
            <div id="statusArea" class="hidden space-y-4">
                <div class="flex justify-between text-[10px] font-black uppercase text-slate-400">
                    <span id="statusText">Extracting Style</span>
                    <span id="percentText">0%</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-1.5">
                    <div id="progressBar" class="bg-indigo-600 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>

            <!-- PROMPT LOG BOX (IMM SICHTBAR) -->
            <div id="promptContainer" class="hidden p-5 bg-slate-900 rounded-2xl border border-slate-800 shadow-inner">
                <span class="text-[9px] font-black text-indigo-400 uppercase tracking-[0.2em] block mb-3">AI Engine Log</span>
                <div id="promptLogBox" class="text-indigo-100 font-mono text-[11px] leading-relaxed opacity-80"></div>
            </div>

            <!-- Result -->
            <div id="resultArea" class="hidden pt-6 space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-700">
                <div class="p-2 bg-white rounded-[2.5rem] shadow-2xl border border-slate-100 relative">
                    <img id="resultImg" class="w-full h-auto rounded-[2rem]" src="">
                </div>
                <button id="downloadBtn" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black uppercase tracking-widest hover:bg-indigo-700 transition-all shadow-xl shadow-indigo-100">
                    Download Result
                </button>
            </div>

            <!-- Error -->
            <div id="errorArea" class="hidden p-4 bg-rose-50 text-rose-600 rounded-2xl text-xs font-bold border border-rose-100 text-center uppercase tracking-widest"></div>
        </div>

        <footer class="mt-10 text-center text-[10px] text-slate-400 font-bold uppercase tracking-[0.4em]">
            MNTG Digital Art System • Resilient v4.0
        </footer>
    </div>

    <script>
        let mode = 'image';
        let artist = 'artist';

        // Token Management
        function saveToken() {
            const tk = document.getElementById('hfTokenInput').value.trim();
            if(tk.startsWith('hf_')) {
                localStorage.setItem('mntg_v4_tk', tk);
                document.getElementById('tokenSection').classList.add('hidden');
                alert("Token gespeichert!");
            }
        }

        window.onload = () => {
            if(localStorage.getItem('mntg_v4_tk')) document.getElementById('tokenSection').classList.add('hidden');
        };

        function setMode(m) {
            mode = m;
            document.getElementById('modeImage').className = m === 'image' ? "py-4 rounded-2xl border-2 border-indigo-600 bg-indigo-600 text-white font-black text-xs uppercase tracking-widest shadow-lg shadow-indigo-200 transition-all" : "py-4 rounded-2xl border-2 border-slate-100 bg-slate-50 text-slate-400 font-black text-xs uppercase tracking-widest hover:border-slate-200 transition-all";
            document.getElementById('modeGif').className = m === 'gif' ? "py-4 rounded-2xl border-2 border-indigo-600 bg-indigo-600 text-white font-black text-xs uppercase tracking-widest shadow-lg shadow-indigo-200 transition-all" : "py-4 rounded-2xl border-2 border-slate-100 bg-slate-50 text-slate-400 font-black text-xs uppercase tracking-widest hover:border-slate-200 transition-all";
        }

        function log(msg, percent = null) {
            const statusArea = document.getElementById('statusArea');
            statusArea.classList.remove('hidden');
            if(percent !== null) {
                document.getElementById('progressBar').style.width = percent + '%';
                document.getElementById('percentText').innerText = percent + '%';
            }
            document.getElementById('statusText').innerText = msg;
        }

        async function ignite() {
            const tk = localStorage.getItem('mntg_v4_tk');
            const urlIn = document.getElementById('artistUrl').value.trim();
            const manualIn = document.getElementById('manualStyle').value.trim();
            
            if(!tk) { alert("Bitte erst Hugging Face Token speichern!"); return; }
            if(!urlIn && !manualIn) return;

            const btn = document.getElementById('generateBtn');
            const errorArea = document.getElementById('errorArea');
            const resultArea = document.getElementById('resultArea');
            const promptBox = document.getElementById('promptContainer');

            btn.disabled = true;
            errorArea.classList.add('hidden');
            resultArea.classList.add('hidden');
            promptBox.classList.add('hidden');

            try {
                let finalKeywords = manualIn;
                artist = urlIn.split('/').filter(p => p).pop() || 'artist';

                if(!manualIn) {
                    log("Scraping Blockchain...", 20);
                    try {
                        const controller = new AbortController();
                        const id = setTimeout(() => controller.abort(), 6000);
                        const res = await fetch(`https://api.tzkt.io/v1/tokens?creator=${artist}&limit=12&sort.desc=id`, { signal: controller.signal });
                        const tokens = await res.json();
                        clearTimeout(id);
                        
                        if(!tokens || tokens.length === 0) throw new Error();
                        finalKeywords = tokens.map(t => t.metadata?.name || '').join(' ').toLowerCase().replace(/[^a-z\s]/g, ' ').split(/\s+/).filter(w => w.length > 4).slice(0, 10).join(', ');
                    } catch (e) {
                        document.getElementById('manualInputGroup').classList.remove('hidden');
                        document.getElementById('mainInputGroup').classList.add('hidden');
                        throw new Error("Connection Error. Bitte Stil manuell eingeben.");
                    }
                }

                const finalPrompt = `A masterpiece transformative digital artwork, visual style inspired by ${finalKeywords}, evocative lighting, artistic textures, fine art composition, high resolution, no text, no signatures, abstract surrealism.`;
                
                document.getElementById('promptLogBox').innerText = finalPrompt;
                promptBox.classList.remove('hidden');

                if(mode === 'image') {
                    log("AI Painting...", 60);
                    const blobUrl = await fetchHF(finalPrompt, tk);
                    show(blobUrl);
                } else {
                    const frames = [];
                    for(let i=0; i<4; i++) {
                        log(`Rendering Frame ${i+1}/4`, 20 + (i*20));
                        if(i > 0) await new Promise(r => setTimeout(r, 4000));
                        frames.push(await fetchHF(finalPrompt + ` variation ${i}`, tk));
                    }
                    log("Finalizing GIF...", 95);
                    gifshot.createGIF({ images: frames, gifWidth: 512, gifHeight: 512, interval: 0.5 }, (obj) => {
                        if(!obj.error) show(obj.image);
                        else throw new Error("GIF Render Error");
                    });
                }

            } catch (err) {
                errorArea.innerText = err.message.toUpperCase();
                errorArea.classList.remove('hidden');
                btn.disabled = false;
            }
        }

        async function fetchHF(prompt, token) {
            // SDXL-Turbo: Das schnellste und zuverlässigste Modell
            const res = await fetch("https://api-inference.huggingface.co/models/stabilityai/sdxl-turbo", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                body: JSON.stringify({ inputs: prompt }),
            });

            if(res.status === 503) {
                log("Model waking up...", 50);
                await new Promise(r => setTimeout(r, 12000));
                return await fetchHF(prompt, token);
            }

            if(!res.ok) throw new Error("Hugging Face Limit oder API Fehler.");
            
            const blob = await res.blob();
            return URL.createObjectURL(blob);
        }

        function show(src) {
            const img = document.getElementById('resultImg');
            img.src = src;
            document.getElementById('resultArea').classList.remove('hidden');
            document.getElementById('statusArea').classList.add('hidden');
            document.getElementById('generateBtn').disabled = false;

            document.getElementById('downloadBtn').onclick = () => {
                const a = document.createElement('a');
                a.href = src;
                a.download = `mntg_style_${artist}.png`;
                a.click();
            };
        }
    </script>
</body>
</html>
