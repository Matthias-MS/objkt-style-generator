<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Objkt Style AI Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gifshot/0.4.5/gifshot.min.js"></script>
    <style>
        .loading-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        @keyframes blink-red { 0%, 50%, 100% { background-color: #4f46e5; } 25%, 75% { background-color: #ef4444; } }
        .error-blink { animation: blink-red 0.6s ease-in-out 2; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans min-h-screen flex items-center justify-center p-4">

    <div class="max-w-xl w-full">
        <!-- Header: Zurück zum sauberen Modern-Look -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-slate-800 tracking-tight">Objkt Style Gen</h1>
            <p class="text-slate-500 mt-2 font-medium">Transformative KI-Kunst von <span class="text-indigo-600">MNTG</span></p>
        </header>

        <!-- Main Card -->
        <div class="bg-white rounded-3xl shadow-2xl shadow-slate-200 p-8 border border-slate-100 space-y-6">
            
            <!-- Link Input -->
            <div id="inputGroup">
                <label class="block text-sm font-semibold text-slate-700 mb-2 tracking-tight">Artist Profil Link</label>
                <input type="text" id="artistUrl" placeholder="https://objkt.com/users/..." 
                    class="w-full px-4 py-4 rounded-2xl border border-slate-200 bg-slate-50 focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 outline-none transition-all text-slate-600">
            </div>

            <!-- Manual Fallback (Nur wenn Blockchain klemmt) -->
            <div id="manualGroup" class="hidden animate-bounce">
                <label class="block text-sm font-bold text-rose-500 mb-2">Blockchain blockiert! Gib den Stil manuell ein:</label>
                <input type="text" id="manualStyle" placeholder="z.B. Abstract Cyberpunk, Oil Painting..." 
                    class="w-full px-4 py-4 rounded-2xl border-2 border-rose-200 bg-rose-50 outline-none">
            </div>

            <!-- Mode Selection -->
            <div class="grid grid-cols-2 gap-4">
                <button id="modeImage" onclick="setMode('image')" class="py-3 rounded-xl border-2 border-indigo-600 bg-indigo-50 text-indigo-700 font-bold transition-all">Bild</button>
                <button id="modeGif" onclick="setMode('gif')" class="py-3 rounded-xl border-2 border-slate-100 bg-slate-50 text-slate-400 font-bold hover:border-slate-200 transition-all">GIF</button>
            </div>

            <!-- Main Button -->
            <button id="generateBtn" onclick="run()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-5 rounded-2xl font-bold text-xl shadow-lg shadow-indigo-200 transition-all active:scale-95">
                Kunstwerk erstellen
            </button>

            <!-- Status Area -->
            <div id="statusArea" class="hidden space-y-3">
                <div class="flex justify-between text-xs font-bold uppercase tracking-wider text-slate-400">
                    <span id="statusText">Initialisiere...</span>
                    <span id="percentText">0%</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                    <div id="progressBar" class="bg-indigo-600 h-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>

            <!-- Error -->
            <div id="errorArea" class="hidden p-4 bg-rose-50 text-rose-600 rounded-2xl text-sm font-medium border border-rose-100 text-center"></div>

            <!-- Result -->
            <div id="resultArea" class="hidden pt-6 border-t border-slate-100 space-y-6 animate-in fade-in duration-700">
                <div class="p-2 bg-slate-50 rounded-3xl border border-slate-100">
                    <img id="resultImg" class="w-full h-auto rounded-2xl shadow-sm" src="" crossorigin="anonymous">
                </div>
                <button id="downloadBtn" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-black transition-all">
                    Download Artwork
                </button>
                
                <!-- Prompt Log: Jetzt lesbar und permanent -->
                <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-2">KI-Analyse-Log</span>
                    <p id="promptLog" class="text-xs text-slate-500 font-mono leading-relaxed"></p>
                </div>
            </div>
        </div>

        <footer class="mt-8 text-center text-xs text-slate-400 font-medium">
            Objkt API & Pollinations Engine • Kostenlos & Transformativ
        </footer>
    </div>

    <script>
        let mode = 'image';
        let artist = 'artist';

        function setMode(m) {
            mode = m;
            document.getElementById('modeImage').className = m === 'image' ? "py-3 rounded-xl border-2 border-indigo-600 bg-indigo-50 text-indigo-700 font-bold transition-all" : "py-3 rounded-xl border-2 border-slate-100 bg-slate-50 text-slate-400 font-bold hover:border-slate-200 transition-all";
            document.getElementById('modeGif').className = m === 'gif' ? "py-3 rounded-xl border-2 border-indigo-600 bg-indigo-50 text-indigo-700 font-bold transition-all" : "py-3 rounded-xl border-2 border-slate-100 bg-slate-50 text-slate-400 font-bold hover:border-slate-200 transition-all";
        }

        function update(p, t) {
            document.getElementById('statusArea').classList.remove('hidden');
            document.getElementById('progressBar').style.width = p + '%';
            document.getElementById('percentText').innerText = p + '%';
            document.getElementById('statusText').innerText = t;
        }

        function fail(msg) {
            const err = document.getElementById('errorArea');
            const btn = document.getElementById('generateBtn');
            err.innerText = msg; err.classList.remove('hidden');
            btn.classList.add('error-blink');
            setTimeout(() => { btn.classList.remove('error-blink'); btn.disabled = false; }, 1000);
            document.getElementById('statusArea').classList.add('hidden');
        }

        async function run() {
            const urlIn = document.getElementById('artistUrl').value.trim();
            const manIn = document.getElementById('manualStyle').value.trim();
            if(!urlIn && !manIn) return;

            artist = urlIn.split('/').filter(p => p).pop() || 'artist';
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('errorArea').classList.add('hidden');
            document.getElementById('resultArea').classList.add('hidden');

            try {
                let finalPrompt = manIn;

                if(!manIn) {
                    update(20, "Analysiere Künstler-Stil...");
                    try {
                        const controller = new AbortController();
                        const id = setTimeout(() => controller.abort(), 5000); // 5s Timeout für Blockchain
                        const res = await fetch(`https://api.tzkt.io/v1/tokens?creator=${artist}&limit=12&sort.desc=id`, { signal: controller.signal });
                        clearTimeout(id);
                        const tokens = await res.json();
                        
                        if(!tokens || tokens.length === 0) throw new Error();
                        
                        const keywords = tokens.map(t => t.metadata?.name || '').join(' ').toLowerCase().replace(/[^a-z\s]/g, ' ').split(/\s+/).filter(w => w.length > 4).slice(0, 10).join(', ');
                        
                        // Der transformative Prompt (keine Kopie, nur Inspiration)
                        finalPrompt = `An original transformative digital artwork, abstract visual language inspired by the color palette and textures of ${keywords}. Evocative lighting, artistic masterpiece, no literal objects, no text, no signatures, 8k resolution.`;
                    } catch (e) {
                        document.getElementById('manualGroup').classList.remove('hidden');
                        document.getElementById('inputGroup').classList.add('hidden');
                        throw new Error("Verbindung blockiert. Gib den Stil bitte manuell ein.");
                    }
                }

                document.getElementById('promptLog').innerText = finalPrompt;

                if (mode === 'image') {
                    update(60, "KI malt dein Bild...");
                    const imgUrl = await getImg(finalPrompt);
                    show(imgUrl);
                } else {
                    const frames = [];
                    for(let i=0; i<4; i++) {
                        update(20 + (i*20), `Rendere Frame ${i+1}/4...`);
                        frames.push(await getImg(finalPrompt + ` variation ${i}`));
                        if(i < 3) await new Promise(r => setTimeout(r, 3000));
                    }
                    update(95, "Erstelle GIF...");
                    gifshot.createGIF({ images: frames, gifWidth: 512, gifHeight: 512, interval: 0.5 }, (obj) => {
                        if(!obj.error) show(obj.image);
                        else fail("GIF-FEHLER.");
                    });
                }
            } catch(e) { fail(e.message); }
        }

        async function getImg(prompt) {
            const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=512&height=512&nologo=true&seed=${Math.random()}&model=turbo`;
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.onload = () => resolve(url);
                img.onerror = () => reject(new Error("KI-Server antwortet nicht. Bitte kurz warten."));
                img.src = url;
                setTimeout(() => reject(new Error("Timeout.")), 35000);
            });
        }

        function show(src) {
            document.getElementById('resultImg').src = src;
            document.getElementById('resultArea').classList.remove('hidden');
            document.getElementById('statusArea').classList.add('hidden');
            document.getElementById('generateBtn').disabled = false;

            document.getElementById('downloadBtn').onclick = async () => {
                const response = await fetch(src);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mntg_style_${artist}.png`;
                a.click();
            };
        }
    </script>
</body>
</html>
