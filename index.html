<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Objkt Style AI Generator</title>
    <!-- CSS und Bibliotheken -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gifshot/0.4.5/gifshot.min.js"></script>
    <style>
        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .loading-pulse { animation: pulse-soft 2s infinite; }
        @keyframes blink-red { 0%, 50%, 100% { opacity: 1; } 25%, 75% { opacity: 0.3; } }
        .error-blink { animation: blink-red 0.6s ease-in-out 2; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans min-h-screen">

    <div class="max-w-3xl mx-auto py-12 px-4">
        <!-- Header -->
        <header class="text-center mb-12">
            <h1 class="text-4xl font-extrabold tracking-tight mb-2 uppercase italic">
                Objkt Artist Style Gen<span class="align-super text-xs ml-1 opacity-40 font-normal">by MNTG</span>
            </h1>
            <p class="text-gray-500">Transformative KI-Kunst basierend auf Artist-Stilen.</p>
        </header>

        <!-- Main Card -->
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-10 border border-gray-100">
            <div class="space-y-6">
                
                <!-- Input Group -->
                <div id="standardInputContainer">
                    <label class="block text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-2">Objkt Artist Profil Link</label>
                    <input type="text" id="artistUrl" 
                        placeholder="https://objkt.com/users/..." 
                        class="w-full px-4 py-4 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-black outline-none transition">
                </div>

                <!-- Mode Selection -->
                <div class="grid grid-cols-2 gap-4">
                    <button id="modeImage" onclick="setMode('image')" 
                        class="py-3 px-4 rounded-xl border-2 transition font-bold text-sm border-black bg-black text-white">
                        Einzelbild
                    </button>
                    <button id="modeGif" onclick="setMode('gif')" 
                        class="py-3 px-4 rounded-xl border-2 transition font-bold text-sm border-gray-100 bg-gray-50 text-gray-400">
                        Animiertes GIF
                    </button>
                </div>

                <!-- Generate Button -->
                <button id="generateBtn" onclick="startGeneration()" 
                    class="w-full bg-black text-white py-5 rounded-xl font-bold text-xl hover:bg-gray-800 transition">
                    Generieren
                </button>

                <!-- Status Area -->
                <div id="statusArea" class="hidden">
                    <div class="flex justify-between mb-2 text-[10px] font-bold uppercase tracking-widest">
                        <span id="statusText" class="text-gray-400 italic">Verarbeite...</span>
                        <span id="percentText" class="text-black">0%</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
                        <div id="progressBar" class="bg-black h-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Error Display -->
                <div id="errorArea" class="hidden p-4 bg-red-50 text-red-600 rounded-xl text-xs border border-red-100 font-bold text-center"></div>

                <!-- Result -->
                <div id="resultArea" class="hidden mt-8 border-t pt-8 text-center animate-in fade-in duration-500">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4 italic">Resultat</h3>
                    <div id="imgContainer" class="inline-block p-2 bg-gray-100 rounded-2xl shadow-inner">
                        <img id="resultImage" src="" alt="AI Result" class="max-w-full rounded-xl shadow-lg mx-auto border border-white" crossorigin="anonymous">
                    </div>
                    <div class="mt-6">
                        <button id="downloadBtn" class="bg-black text-white px-8 py-3 rounded-full font-bold text-xs uppercase tracking-widest hover:scale-105 transition">
                            Download Artwork
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-20 text-center text-[10px] text-gray-300 uppercase tracking-[0.3em] leading-relaxed">
            Nutzt die Objkt API & Pollinations.ai • MNTG SYSTEM
        </footer>
    </div>

    <script>
        let currentMode = 'image';
        let currentArtistName = 'artist';

        function setMode(mode) {
            currentMode = mode;
            const imgBtn = document.getElementById('modeImage');
            const gifBtn = document.getElementById('modeGif');
            if (mode === 'image') {
                imgBtn.className = "py-3 px-4 rounded-xl border-2 transition font-bold text-sm border-black bg-black text-white";
                gifBtn.className = "py-3 px-4 rounded-xl border-2 transition font-bold text-sm border-gray-100 bg-gray-50 text-gray-400";
            } else {
                gifBtn.className = "py-3 px-4 rounded-xl border-2 transition font-bold text-sm border-black bg-black text-white";
                imgBtn.className = "py-3 px-4 rounded-xl border-2 transition font-bold text-sm border-gray-100 bg-gray-50 text-gray-400";
            }
        }

        function updateProgress(percent, text) {
            document.getElementById('statusArea').classList.remove('hidden');
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('percentText').innerText = percent + '%';
            document.getElementById('statusText').innerText = text;
        }

        function showError(msg) {
            const err = document.getElementById('errorArea');
            err.innerText = msg;
            err.classList.remove('hidden');
            document.getElementById('statusArea').classList.add('hidden');
            document.getElementById('generateBtn').disabled = false;
        }

        async function startGeneration() {
            const urlInput = document.getElementById('artistUrl').value.trim();
            const btn = document.getElementById('generateBtn');
            const resultArea = document.getElementById('resultArea');

            if (!urlInput) { showError("Bitte gib einen Link ein."); return; }
            
            // Artist Name extrahieren
            currentArtistName = urlInput.split('/').filter(p => p).pop() || 'artist';

            btn.disabled = true;
            resultArea.classList.add('hidden');
            document.getElementById('errorArea').classList.add('hidden');

            try {
                updateProgress(10, "Lade Artist Metadaten...");
                const res = await fetch(`https://api.tzkt.io/v1/tokens?creator=${currentArtistName}&limit=8&sort.desc=id`);
                const tokens = await res.json();
                
                let keywords = "abstract digital art, unique composition";
                if (tokens && tokens.length > 0) {
                    keywords = tokens.map(t => t.metadata?.name || '').join(', ').slice(0, 100);
                }

                if (currentMode === 'image') {
                    updateProgress(50, "KI generiert Bild...");
                    const seed = Math.floor(Math.random() * 999999);
                    const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(keywords + " artistic style, no text, masterpiece")}?width=512&height=512&seed=${seed}&nologo=true`;
                    
                    await forceLoadImage(url);
                    displayResult(url);
                } else {
                    if (typeof gifshot === 'undefined') throw new Error("Bibliothek lädt noch. Bitte 2 Sek warten.");
                    
                    const frames = [];
                    for(let i=0; i<4; i++) {
                        updateProgress(20 + (i*20), `KI erstellt Frame ${i+1}/4...`);
                        const seed = Math.floor(Math.random() * 999999);
                        const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(keywords + " motion style")}?width=512&height=512&seed=${seed}&nologo=true`;
                        frames.push(url);
                        await new Promise(r => setTimeout(r, 2000));
                    }
                    
                    updateProgress(90, "GIF wird gerendert...");
                    gifshot.createGIF({
                        images: frames,
                        gifWidth: 512,
                        gifHeight: 512,
                        interval: 0.5
                    }, (obj) => {
                        if (!obj.error) {
                            displayResult(obj.image);
                        } else {
                            showError("GIF Fehler.");
                        }
                    });
                }
            } catch (err) {
                showError("Fehler: " + err.message);
            }
        }

        // Hilfsfunktion: Wartet bis Bild wirklich geladen ist
        function forceLoadImage(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.onload = () => resolve();
                img.onerror = () => reject(new Error("Bild konnte nicht geladen werden."));
                img.src = url;
                setTimeout(() => reject(new Error("Zeitüberschreitung.")), 30000);
            });
        }

        function displayResult(source) {
            const resImg = document.getElementById('resultImage');
            resImg.src = source;
            document.getElementById('resultArea').classList.remove('hidden');
            document.getElementById('statusArea').classList.add('hidden');
            document.getElementById('generateBtn').disabled = false;
            
            // Download Logik mit Blob-Konvertierung (verhindert leere Dateien)
            document.getElementById('downloadBtn').onclick = async () => {
                const btn = document.getElementById('downloadBtn');
                btn.innerText = "LÄDT...";
                try {
                    const response = await fetch(source);
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `mntgstyleart_${currentArtistName}.${currentMode === 'image' ? 'png' : 'gif'}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } catch (e) {
                    // Fallback falls Blob fehlschlägt
                    window.open(source, '_blank');
                }
                btn.innerText = "DOWNLOAD ARTWORK";
            };
        }
    </script>
</body>
</html>
